version: '3.8'

services:
  # Main LLMBot Service
  llmbot:
    image: sudoskys/llmbot:latest
    container_name: llmbot_personal_assistant
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Override any environment variables here
      - TZ=UTC
      - DEBUG=${DEBUG:-false}
    volumes:
      # Configuration directory for persistent storage
      - ./config_dir:/app/config_dir
      # Logs directory
      - ./logs:/app/logs
      # Custom plugins directory
      - ./custom_plugins:/app/llmkira/extra/plugins/custom:ro
    networks:
      - bot_network2
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '2.0'      # Limit CPU usage
          memory: 2G       # Limit memory usage
        reservations:
          cpus: '0.5'      # Reserve minimum CPU
          memory: 512M     # Reserve minimum memory
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # RabbitMQ Message Queue (Required)
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: llmbot_rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-StrongPassword123!}
    ports:
      - "127.0.0.1:15672:15672"  # Management UI (localhost only)
    expose:
      - "5672"  # AMQP port (internal only)
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - rabbitmq_logs:/var/log/rabbitmq
    networks:
      - bot_network2
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Redis Cache (Optional but recommended for performance)
  redis:
    image: redis:7-alpine
    container_name: llmbot_redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-StrongRedisPass123!}
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    networks:
      - bot_network2
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # MongoDB (Optional - remove if not needed)
  # Uncomment if you need document storage
  # mongodb:
  #   image: mongo:6-jammy
  #   container_name: llmbot_mongodb
  #   restart: unless-stopped
  #   environment:
  #     MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
  #     MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS:-StrongMongoPass123!}
  #     MONGO_INITDB_DATABASE: llmbot
  #   expose:
  #     - "27017"
  #   volumes:
  #     - mongodb_data:/data/db
  #     - mongodb_config:/data/configdb
  #   networks:
  #     - bot_network
  #   healthcheck:
  #     test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 512M

  # Nginx Reverse Proxy (Optional - for webhooks)
  # Uncomment if you need external webhook access
  # nginx:
  #   image: nginx:alpine
  #   container_name: llmbot_nginx
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   networks:
  #     - bot_network
  #   depends_on:
  #     - llmbot

  # Backup Service (Optional - automated backups)
  # Uncomment for automated backups
  # backup:
  #   image: alpine:latest
  #   container_name: llmbot_backup
  #   restart: unless-stopped
  #   volumes:
  #     - ./backups:/backups
  #     - ./config_dir:/data/config:ro
  #     - rabbitmq_data:/data/rabbitmq:ro
  #     - redis_data:/data/redis:ro
  #   command: >
  #     sh -c "while true; do
  #       tar -czf /backups/backup-$$(date +%Y%m%d-%H%M%S).tar.gz /data/;
  #       find /backups -type f -mtime +7 -delete;
  #       sleep 86400;
  #     done"
  #   networks:
  #     - bot_network

networks:
  bot_network2:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
    driver_opts:
      com.docker.network.bridge.name: llmbot_bridge

volumes:
  # RabbitMQ volumes
  rabbitmq_data:
    driver: local
  rabbitmq_logs:
    driver: local

  # Redis volume
  redis_data:
    driver: local

  # MongoDB volumes (if enabled)
  # mongodb_data:
  #   driver: local
  # mongodb_config:
  #   driver: local

# Secrets (for production use)
# secrets:
#   discord_token:
#     file: ./secrets/discord_token.txt
#   openai_key:
#     file: ./secrets/openai_key.txt
#   rabbitmq_password:
#     file: ./secrets/rabbitmq_password.txt